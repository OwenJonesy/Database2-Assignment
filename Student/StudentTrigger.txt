-- Updated ApplyPayment Function
CREATE OR REPLACE FUNCTION ApplyPayment(student_id INT, amount DECIMAL(10, 2))
RETURNS BOOLEAN AS $$
BEGIN
    -- Update the student's amount due by deducting the payment amount
    UPDATE DrivingStudent
    SET AmountDue = AmountDue - amount
    WHERE StudentID = student_id;

    RETURN TRUE;
END;
$$ LANGUAGE plpgsql;

-- Deferred ApplyPayment Function
CREATE OR REPLACE FUNCTION DeferredApplyPayment()
RETURNS TRIGGER AS $$
BEGIN
    -- Update the student's amount due by deducting the payment amount
    UPDATE DrivingStudent
    SET AmountDue = AmountDue - NEW.Amount
    WHERE StudentID = NEW.StudentID;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Deferred Payment Trigger
CREATE OR REPLACE FUNCTION DeferredPaymentTrigger()
RETURNS TRIGGER AS $$
BEGIN
    -- Call the ApplyPayment function with the payment details
    PERFORM ApplyPayment(NEW.StudentID, NEW.Amount);
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Drop the existing trigger
DROP TRIGGER IF EXISTS deferredpaymenttrigger ON Payment;


CREATE TRIGGER DeferredPaymentTrigger
AFTER INSERT ON Payment
FOR EACH ROW
EXECUTE FUNCTION DeferredPaymentTrigger();





